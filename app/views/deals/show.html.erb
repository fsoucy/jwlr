<h1>Welcome to the deal between <%= @deal.seller.name %> (seller) and <%= @deal.buyer.name %> (buyer)</h1>
<h2>Payment complete: <%= @deal.payment_complete %></h2>
<h2>Product received: <%= @deal.product_received %></h2>
<h2>Deal complete: <%= @deal.deal_complete %></h2>
<%= image_tag @deal.product.pictures.first.photo %>
<h2>Listed price: <%= @deal.product.price %></h2>
<% if @deal.buyer.id == current_user.id %>
<%= form_for(@deal) do |f| %>
<p>Selling Methods (choose one)</p>
<% @deal.product.selling_method_links.each do |s| %>
<%= f.label :selling_method, "#{s.selling_method.method}" %>
<%= f.radio_button :selling_method_id, s.selling_method.id %>
<% end %>
<p>Exchange Methods (choose one) </p>
<% @deal.product.exchange_method_links.each do |e| %>
<%= f.label :exchange_method, "#{e.exchange_method.method}" %>
<%= f.radio_button :exchange_method_id, e.exchange_method.id %>
<% end %>
<p>Payment Methods (choose one)</p>
<% @deal.product.payment_method_links.each do |p| %>
<%= f.label :payment_method, "#{p.payment_method.method}" %>
<%= f.radio_button :payment_method_id, p.payment_method.id %>
<% end %>
<br>
<%= f.submit "Save new method preferences" %>
<% end %>
<% else %>
<% if !SellingMethodLink.where("selling_method_id IN (?,?) AND product_id=?", 3, 4, @deal.product.id) %>
<%= form_for @deal.product do |f| %>
<h3>Minimum Accepted Price: <%= f.number_field :min_accepted_price %><%= f.submit "Change" %></h3>
<% end %>
<% end %>
<h3>The user has selected these transaction methods:</h3>
<h4>Selling Methods: <%= SellingMethod.find(@deal.selling_method_id).method unless @deal.selling_method_id.nil?  %></h4>
<h4>Exchange Methods: <%= ExchangeMethod.find(@deal.exchange_method_id).method unless @deal.exchange_method_id.nil?  %></h4>
<h4>Payment Methods: <%= PaymentMethod.find(@deal.payment_method_id).method unless @deal.payment_method_id.nil?  %></h4>
<% end %>
<br>
<% selling_method = SellingMethod.find(@deal.selling_method_id) unless @deal.selling_method_id.nil? %>
<% if !selling_method.nil? %>
  <h2>Selling Method: <%= selling_method.method %></h2>
    <% if selling_method.id == 3 or selling_method.id == 4 %>
      <% if @deal.proposed_price_accepted %>
        <h3>The deal is going through for <%= @deal.user_proposed_price %></h3>
      <% else %>
      <% if current_user.id == @deal.buyer_id %>
        <h3>Listed price: <%= @deal.product.price %></h3>
	<!--<h3>iGold's suggested value for premium users</h3>-->
	<%= form_for(@deal) do |f| %>
	  <h3 id="price_warning">Price is too low! Not accepted.</h3>
	  <%= f.hidden_field :min_price, value: @deal.product.min_accepted_price, id: "minimum_price" %>
	  <h3>Your price: <%= f.number_field :user_proposed_price, value: @deal.user_proposed_price, id: "price_proposal" %>  <%= f.submit "Change offer", class: "propose_price" %></h3>
	<% end %>
      <% end %>
      <% if current_user.id == @deal.seller_id %>
        <h3>Listed price: <%= @deal.product.price %></h3>
	<%= form_for @deal do |f| %>
	  <%= f.hidden_field :proposed_price_accepted, value: true %>
	  <h3>Offered price: <%= @deal.user_proposed_price %>  <%= f.submit "Accept offer" %></h3>
	<% end %>
      <% end %>
    <% end %>
  <% end %>
  <% if selling_method.id == 2 %>
    <h3>This product has a set price: <%= @deal.product.price %></h3>
  <% end %>
<% end %>
<% exchange_method = ExchangeMethod.find(@deal.exchange_method_id) unless @deal.exchange_method_id.nil? %>
<% if !exchange_method.nil? %>
<h2>Exchange Method: <%= exchange_method.method %></h2>
<% if current_user.id == @deal.buyer_id %>
<h3>Maximum delivery distance in miles: <%= @deal.product.maximum_delivery_radius_miles unless @deal.product.maximum_delivery_radius_miles.nil? %></h3>
<h3>Delivery cost: <%= @deal.product.delivery_charge %></h3>
<%= form_for(@deal) do |f| %>
<h3>Your location for delivery: <%= f.text_field :dropoff %>  <%= f.submit "Save" %></h3>
<% end %>
<% end %>
<% if current_user.id == @deal.seller_id %>
<%= form_for(@deal.product) do |f| %>
<h3>Maximum delivery distance in miles: <%= f.number_field :maximum_delivery_radius_miles %></h3>
<h3>Delivery cost: <%= f.number_field :delivery_charge %></h3>
<%= f.submit "Save changes on delivery exchange" %>
<% end %>
<h3>Delivery location: <%= @deal.dropoff %></h3>
<% end %>
<% end %>
<%= form_for @deal do |f| %>

<% payment_method = PaymentMethod.find(@deal.payment_method_id) unless @deal.payment_method_id.nil? %>
<% if !payment_method.nil? %>
<h2>Payment Method: <%= payment_method.method %></h2>
<% end %>
