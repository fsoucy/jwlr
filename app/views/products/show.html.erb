<% title = "Product by " + @product.user.name %>
<div class="pure-g pad-box">
	<div class="pure-u-1 pure-u-md-1-5 product_view pad-box">
  
  	<% if !@product.pictures.first.nil? %>
  	  <a id="magnifier" href="<%= @product.pictures.first.photo_cropped(:large) %>">
   		  <%= image_tag @product.pictures.first.photo_cropped(:medium), class: "pad-box product_image pure-img" %>
  	  </a>
  		<% if @product.user == current_user %>
  		<%= link_to("Edit", edit_picture_path(@product.pictures.first), class: 'product_edit' ) %>
  		<% end %>
  	<% end %>
  	<br>
  	<% @product.pictures.each do |picture| %>
	<div class="pickers">
  		<% if picture == @product.pictures.first %>
  			<%= image_tag picture.photo_cropped(:thumbnail), class: "cropped_show pic_active" %>
  		<% else %>
  			<%= image_tag picture.photo_cropped(:thumbnail), class: "cropped_show" %>
  		<% end %>
		<%= hidden_field_tag :mag, picture.photo_cropped(:large), { class: 'mag_link' } %>
		<% if @product.user == current_user %>
		
  		<%= hidden_field_tag :pathway, edit_picture_path(picture), { class: 'pathway' } %>
  		<% end %>
	</div>
  	<% end %>

	</div>
	<div class="pure-u-1 pure-u-md-2-5 product_view pad-box">
    	<h1 class="no-margin"><%= @product.title %></h1>
      <%= @product.user.name %> - <%= @distance_away.round(1) %> miles from you - <%= @product.user.score %>% rating
      <p>
        <h3 class="inline-header">Price:</h3> 
        <%= number_to_currency(@product.price) %>
      </p>
      <p>
        <h3 class="inline-header">Views:</h3> 
        <%= @product.views %>
      </p>

      <table class="pure-table pure-table-bordered pure-table-striped product_attributes">
	<tbody>
	  <tr>
	    <td>Type</td>
	    <td><%= @product.category.name %></td>
	  </tr>
	  <% @toggle_options.each do |opt| %>
	        <% if opt.attribute_option.value != "Not Specified" %>
            <tr>
              <td><%= opt.attribute_option.category_option.name %></td>
              <td><%= opt.attribute_option.value %></td>
            </tr>
          <% end %>
	      <% end %>
      </tbody>
    </table>
  </div>

  <div class="pure-u-1 pure-u-md-2-5 product_view pad-box log-in">
    <% if @product.store != nil %>
      <h1><%= @product.store.name %></h1>
    <% else %>
      <h1><%= @product.user.name %></h1>
    <% end %>
    <p>
    <% if !@product.sold && !@product.hold %>
  		<% if @product.user == current_user %><%= link_to "Delete this product", @product, method: :delete, class: "btn btn-primary down",
					    data: { confirm: "Are you sure you wish to delete this?" } %>
  		  <br>
        <%= link_to "Edit product", edit_product_path(@product.id) %>
      <% end %>
    <% end %>      
  
    <% if @product.user == current_user %>
    <div class="log-in-form">
      <a href="<%= edit_selling_methods_product_path(@product) %>"><h1 class = "method_alert">Selling Methods</h1></a>
      <% @product.selling_method_links.each do |s| %>
        <h3><%= s.selling_method.method %></h3>
      <% end %>
  
      <a href="<%= edit_exchange_methods_product_path(@product) %>"><h1 class = "method_alert">Exchange Methods</h1></a>
      <% @product.exchange_method_links.each do |s| %>
        <h3><%= s.exchange_method.method %></h3>
        <% if s.exchange_method.method == "Delivery" %>
          <h4>Delivery cost: <%= number_to_currency(@product.delivery_cost) %></h4>
        <% end %>
      <% end %>
      <a href="<%= edit_selling_methods_product_path(@product) %>"><h1 class = "method_alert">Payment Methods</h1></a>
      <% @product.payment_method_links.each do |s| %>
        <h3><%= s.payment_method.method %></h3>
      <% end %>
      </div>
    <% else %>

      <% if !@product.sold and !@product.hold %>
        <% if logged_in? %>
      	  <% active_deal = Deal.where("product_id = ? and buyer_id = ?", @product.id, current_user).first %>
          <% if active_deal.nil? %>
            <% if @product.buy_now %>
              <%= render 'buy_now' %>
            <% end %>
            <% if @product.only_buy_now %>
            <% else %>
              <%= form_for(@deal, html: { class: "pure-form pure-form-stacked log-in-form methods deal_extended"}) do |f| %>
                <h3>Selling Methods (choose one)</h3>
                <% @deal.product.selling_method_links.each do |s| %>
                  <% if s.selling_method.method == "Static Price" %>
                    <%= f.label :selling_method, "Static Price ($#{@deal.product.price})", class: "pure-radio deal_selling_label" %>
                  <% else %>
                    <%= f.label :selling_method, "Negotiation (listed price: $#{@deal.product.price})", class: "pure-radio deal_selling_label" %>
                  <% end %>
                  <%= f.radio_button :selling_method_id, s.selling_method.id, class: "deal_selling" %>
                  <% if s.selling_method.method == "Negotiation" %>
                    <%= f.number_field :user_proposed_price %>
                  <% end %>
                  <br>
                <% end %>
                <h3>Exchange Methods (choose one) </h3>
                <% @deal.product.exchange_method_links.each do |e| %>
                  <%= f.label :exchange_method, "#{e.exchange_method.method}", class: "pure-radio deal_exchange_label" %>
                    <%= f.radio_button :exchange_method_id, e.exchange_method.id, class: "deal_exchange" %>
		              <br>
                <% end %>
                <h3>Payment Methods (choose one)</h3>
                <% @deal.product.payment_method_links.each do |p| %>
                  <%= f.label :payment_method, "#{p.payment_method.method}", class: "pure-radio deal_payment_label" %>
                  <%= f.radio_button :payment_method_id, p.payment_method.id, class: "deal_payment" %>
                  <br>
                <% end %>
                <br>
		            <%= f.hidden_field :product_id, value: @product.id %>
		            <%= f.hidden_field :seller_id, value: @product.user.id %>
		            <%= f.hidden_field :buyer_id, value: current_user.id %>
                <%= f.submit "Buy this product", class: "pure-button pure-button-primary" %>
              <% end %>
            <% end %>
          <% else %>
            <%= link_to "Go to your deal", active_deal %>
          <% end %>
        <% else %>
          <% store_location %>
          <%= form_tag "/login", method: "get", class: "log-in-form" do %>
            <%= submit_tag "Buy this product", class: 'pure-button pure-button-primary' %>
          <% end %>
        <% end %>
      <% else %>
        <h1>Product is unavailable for sale.</h1>
      <% end %>  
    <% end %>
    </p>
  </div>
</div>

<div class="pure-g pad-box">
  <div class="pure-u-1 pure-u-md-1-5 pad-box">
 
  </div>
  <div class="pure-u-1 pure-u-md-2-5 pad-box">
    <h3>Product Description</h3>
    <p><%= @product.description %></p>
  </div>
  <div class="pure-u-1 pure-u-md-1-5"></div>
</div>

<h1 class="content-subhead">Related Products</h1>
<div class="more_like_this pure-g">
  <% unless @more_like_this.nil? %>
  <% @more_like_this.each do |prod| %>
  <div class="pure-u-1 pure-u-md-1-5 pad-box">
    <%= render prod %>
  </div>
    <% end %>
  <% end %>
</div>

